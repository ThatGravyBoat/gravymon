<html>
  <head>
    <title>Pink Fluffy Unicorn Game Engine</title>
    <link href="https://fonts.googleapis.com/css?family=Bubblegum+Sans" rel="stylesheet">
    <link rel='stylesheet' href='unicorn.css' />
    <script src="pinkfluffyunicorn.min.js"></script>
    <script src="comfy.min.js"></script>
  </head>
  <body>
    <div id="unicorn-display"></div>
    <audio id="audio" controls="" style="visibility: hidden;">
      <source id="source" type="audio/wav">
    </audio>
    <script>
      var counter = 0;
      function getRandomInt( number ) {
        return Math.floor( number * Math.random() );
      }

      function launchConfetti( imageOverride = "" ) {
            counter++;
            switch( Math.floor( 8 * Math.random() ) ) {
              case 0:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2 + Math.PI / 10,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -50);
                break;
              case 1:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2 - Math.PI / 10,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -70);
                break;
              case 2:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2 + Math.PI / 5,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -59);
                break;
              case 3:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -100);
                break;
              case 4:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2 + Math.PI / 10,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -50);
                break;
              case 5:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2 - Math.PI / 10,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -70);
                break;
              case 6:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2 + Math.PI / 5,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -59);
                break;
              case 7:
                Unicorn.AddParticles( "Confetti" + counter, {
                  blendMode: PIXI.BLEND_MODES.DEFAULT,
                  shape: "line", // "cone", "line"
                  // lineDirection: 0,
                  // length: 400,
                  angle: Math.PI / 2,
                  startColor: "#ffffff",
                  endColor: "#ffffff",
                  intensity: 0.75, // Scale from 1 - 10
                  minSpeed: 0.05,
                  maxSpeed: 0.5,
                  decay: 10, // Scale from 0 - 10
                  image: imageOverride || "assets/bit.png",
                }, 0, -100);
                break;
            }
            stopParticles( "Confetti" + counter, 2000 );
          }

          function superlaunchConfetti(numberOfTimes, imageOverride  = "" ){
                for (let step = 0; step < numberOfTimes; step++) {
                  launchConfetti(imageOverride)
                }
          }

      function stopParticles( name, time = 2000 ) {
        setTimeout( () => {
          Unicorn.RemoveParticles( name );
        }, time );
      }

      let params = new URLSearchParams( location.search );

      var a = {
        idle_robot: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
        wave_robot: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
      },
      n = null,
      t = null,
      i = {},
      o = [],
      l = !1;

      function init() {
        Unicorn.Load("bit", "./assets/bit.png");
        Unicorn.Load("gift", "./assets/gift.png");
        ! function (e = "") {
            Unicorn.Load("speech", "assets/speech_bubble.png"), e && (e = "_" + e);
            for (var n = 0, t = 0; t < 23; t++) n + 1 < a[`idle${e}`].length && t === a[`idle${e}`][n + 1] && n++, Unicorn.Load("idle" + t, `./assets/idle${e}/idle` + ("0" + a[`idle${e}`][n]).slice(-2) + ".png");
            n = 0;
            for (var t = 0; t < 14; t++) n + 1 < a[`wave${e}`].length && t === a[`wave${e}`][n + 1] && n++, Unicorn.Load("wave" + t, `./assets/wave${e}/wave` + ("0" + a[`wave${e}`][n]).slice(-2) + ".png")
          }("robot");
        Unicorn.AddObject("robot", {
            type: "rectangle",
            x: 70,
            y: 960,
            width: 225,
            height: 225,
            animations: {
                 idle: {
                    framerate: .18,
                     frames: [...Array(23).keys()].map(e => `idle${e}`),
                     loop: !0
                },
                wave: {
                    framerate: .18,
                    frames: [...Array(14).keys()].map(e => `wave${e}`),
                    loop: !1,
                    onComplete: () => {
                         t.text = "", n.visible = !1, l = !1, 0 === o.length && Unicorn.PlayObjectAnimation("robot", "idle")
                    }
                }
            },
            isStatic: !0
        });
        (n = Unicorn.AddOverlay("speech", "speech", 175, 775)).scale = {
            x: 1,
            y: 1
        }, (t = Unicorn.AddText("speechText", "", 375, 825, {
            fontFamily: "Gloria Hallelujah",
            fontSize: 16,
            fontWeight: "bold",
            fill: "#000000"
        })).anchor.set(.5), n.visible = !1
    }

      function update() {
        if (!l && o.length > 0) {
            l = !0;
            var i = o.shift();
            t.text = `Hi, ${i}!`, n.visible = !0, Unicorn.PlayObjectAnimation("robot", "wave")
        }
      }
      function speechMessage(message) {
        t.text = message, n.visible = !0, Unicorn.PlayObjectAnimation("robot", "wave")
        setTimeout(function() {n.visible = !1}, 3000)
      }

      function OnChatMessage( user, message, flags, self, extra ) {
        
      }
      function OnChatCommand( user, command, message, flags, extra) {
        if( command === "testsub" && user.toLowerCase() == "thatgravyboat") {onSubGift(message)}
        if( command === "testcheer" && user.toLowerCase() == "thatgravyboat") {onCheer(message)}
        if( command === "testspeech" && user.toLowerCase() == "thatgravyboat") {speechMessage(message)}
      }
      ComfyJS.onCheer = ( user, message, bits, flags, extra ) => {
        console.log('user: ' +user)
        console.log('message: ' +message)
        console.log('bits: ' +bits)
        console.log('flags: ' + flags)
        console.log('extra: ' + extra )
        speechMessage('Thanks for the bits ' + user.displayName)
        superlaunchConfetti(5)
      }
      ComfyJS.onSubGift = ( gifterUser ) => {
          speechMessage('Thanks for the gift sub(s) ' + gifterUser)
          superlaunchConfetti(10, './assets/gift.png')
      }


      async function speakMessage( message, ttsVoice = "Amy" ) {
        let speak = await fetch( `https://api.streamelements.com/kappa/v2/speech?voice=${ttsVoice}&text=` + encodeURIComponent( message.trim() ) );
      	if( speak.status != 200 ) {
      		// await speak.text();
      		return;
      	}

        let mp3 = await speak.blob();
        let blobUrl = URL.createObjectURL( mp3 );
      	document.getElementById( "source" ).setAttribute( "src", blobUrl );
      	let audio = document.getElementById( "audio" );
      	audio.pause();
      	audio.load();
        audio.volume = 1;
      	audio.play();
      }

      window.addEventListener('load', () => {
        Unicorn.Create( "unicorn-display", {
          width: 1920,
          height: 1080,
          background: "transparent",
          init: init,
          update: update,
          channel: params.get( "channel" ),
          onChat: OnChatMessage,
          onCommand: OnChatCommand,
          // screenWalls: false // Default: true
          // gravity: { x: 0, y: 0.5 } // Default: { x: 0, y: 1 }
        });
      });
    </script>
  </body>
</html>
